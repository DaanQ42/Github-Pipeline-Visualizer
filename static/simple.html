<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Sample Site</title>
    <link rel="stylesheet" href="./main.css" />
    <link rel="stylesheet" href="./simple.css" />
  </head>

  <body>
    <h1 id="status"></h1>
    <div id="container"></div>
    <script type="module">
      function get_job(job_id) {
        const job = document.getElementById(`job-${job_id}`);
        if (job) {
          return job;
        }

        const container = document.getElementById("container");
        const new_job = document.createElement("div");
        container.appendChild(new_job);
        new_job.id = `job-${job_id}`;
        return new_job;
      }

      import { EventConnection } from "./scripts/modules/websocket.mjs";
      const host = window.location.host;
      const events = new EventConnection(`ws://${host}/websockets`);

      events.on_connection_state((state) => {
        document.getElementById("status").innerHTML = `Status: ${state}`;
      });
      events.workflow_update((workflow_update) => {
        const job = get_job(workflow_update.id);
        job.innerHTML = `<h2 class="workflow ${workflow_update.conclusion ?? ""} ${workflow_update.status ?? ""}">${
          workflow_update.name
        }</h2>`;
        // Converts the steps to a list
        const steps = Object.values(workflow_update.steps).map((step) => {
          return `<li class="step ${step.conclusion} ${step.status}">${step.name}</li>`;
        });
        job.innerHTML += `<ul>${steps.join("")}</ul>`;

        if (workflow_update.status === "completed") {
          setTimeout(() => {
            job.remove();
          }, 10000);
        }
      });
    </script>
  </body>
</html>
